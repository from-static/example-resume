name: static-version-watch
on:
  workflow_call:
  workflow_dispatch:
      
permissions:
  contents: read
  pull-requests	: write
  issues: write
  id-token: write

jobs:
  static-version-watch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Parse static.json
        id: static
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const path = require("path");
            const staticConfig = JSON.parse(fs.readFileSync("./static.json", "utf8"));
            const {
              generator,
              version
            } = staticConfig._static;
            // If there isn't a version, the respository is always using the default branch
            if (!version) {
              console.log("No version found in static.json");
              return;
            };
            let nextVersion = null;
            try {
              nextVersion = parseInt(version.split(".")[0].replace("v", "")) + 1;
            } catch (e) {
              console.log("Error parsing version", e);
              return;
            }
            const [owner, repo] = generator.split("/");
            const branch = `v${nextVersion}`;
            try {
              const response = await github.rest.repos.getBranch({
                owner,
                repo,
                branch
              });
            } catch (e) {
              console.log(`Error fetching next version (${branch}), it might not be published yet!`);
              return;
            }
            console.log(`Attempting to open a Pull Request to suggest updating to ${branch}`);
            github.rest.issues.create({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `static: ${generator}@${branch} is available!`,
              body: 'ðŸ‘‹'
            })